name: Release

on:
    push:
        branches: 
            - main
            - 'feature/development'

env:
  AWS_REGION : "eu-west-1"    # AWS region where s3 bucket is deployed
  
jobs:

  # This job runs our automated build process including
  # git clone repository
  # setting up HUGO development server
  # build artifact for the website
  # obtain OIDC token from aws
  # sync s3 bucket
  # create cloudfront cache invalidation 
    build_job:
        name: Build website
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                hugo-version: 'latest'
                extended: true

            - name: Build
              run: hugo

            - name: Upload Build Artifact
              uses: actions/upload-artifact@v4
              with:
                name: tech-blog
                path: public/*

    deploy_job:
        name: Publish website
        needs: [build_job]
        runs-on: ubuntu-latest
        permissions:
          id-token: write     # This is required for requesting the JWT
          contents: read      # This is required for actions/checkout

        steps:

            - name: Download Build Artifacts
              uses: actions/download-artifact@v4
              with:
                name: tech-blog

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{secrets.AWS_IAM_ROLE}}
                aws-region: ${{ env.AWS_REGION }}

            - name: S3 sync
              run: | 
                aws s3 sync tech-blog/ s3://${{secrets.BUCKET_NAME}} \
                --delete

            - name: Create CloudFront Invalidation
              run: |
                aws cloudfront create-invalidation \
                --distribution-id ${{vars.DISTRIBUTION_ID}} \
                --paths "/*"
                



              

